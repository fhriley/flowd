# $Id$

PROGVER=0.1

prefix=@prefix@
exec_prefix=@exec_prefix@
bindir=@bindir@
sbindir=@sbindir@
libexecdir=@libexecdir@
datadir=@datadir@
mandir=@mandir@
sysconfdir=@sysconfdir@
srcdir=@srcdir@
top_srcdir=@top_srcdir@
localstatedir=@localstatedir@

PIDFILEDIR=@PIDPATH@

PATHFLAGS=-DSYSCONFDIR="\"$(sysconfdir)\"" -DPIDFILEDIR="\"$(PIDFILEDIR)\""
PROGFLAGS=-DPROGVER="\"$(PROGVER)\""

VPATH=@srcdir@
CC=@CC@
LDFLAGS=@LDFLAGS@
CFLAGS=@CFLAGS@
CPPFLAGS=-I$(srcdir) @CPPFLAGS@ $(PATHFLAGS) $(PROGFLAGS)
LIBS=@LIBS@
EXEEXT=@EXEEXT@
INSTALL=@INSTALL@
RANLIB=@RANLIB@

# Bison doesn't work
YACC=@YACC@

TARGETS=flowd flowd-reader

all: $(TARGETS)

LIBFLOWD_OBJS=		atomicio.o addr.o store.o crc32.o closefrom.o \
			strlcpy.o strlcat.o setproctitle.o
FLOWD_OBJS=		flowd.o privsep_fdpass.o privsep.o filter.o parse.o
FLOWD_READER_OBJS=	flowd-reader.o

libflowd.a: $(LIBFLOWD_OBJS)
	$(AR) rv $@ $(LIBFLOWD_OBJS)
	$(RANLIB) $@

parse.c: $(top_srcdir)/parse.y
	$(YACC) $(top_srcdir)/parse.y
	mv y.tab.c parse.c
	rm -f y.tab.h

flowd: $(FLOWD_OBJS) libflowd.a
	$(CC) $(LDFLAGS) -L. -o $@ $(FLOWD_OBJS) -lflowd $(LIBS)

flowd-reader: $(FLOWD_READER_OBJS) libflowd.a
	$(CC) $(LDFLAGS) -L. -o $@ $(FLOWD_READER_OBJS) libflowd.a $(LIBS)

clean:
	rm -f $(TARGETS) *.o core *.core y.tab.* parse.c

realclean: clean
	rm -rf autom4te.cache Makefile config.log config.status
	rm -f flowd.8 flowd-reader.8 flowd.conf.5

distclean: realclean
	rm -f config.h* configure

strip:
	strip $(TARGETS)

install:
	$(srcdir)/mkinstalldirs $(DESTDIR)$(sbindir)
	$(srcdir)/mkinstalldirs $(DESTDIR)$(bindir)
	$(srcdir)/mkinstalldirs $(DESTDIR)$(mandir)/man5
	$(srcdir)/mkinstalldirs $(DESTDIR)$(mandir)/man8
	$(INSTALL) -m 0755 -s flowd $(sbindir)/flowd
	$(INSTALL) -m 0755 -s flowd-reader $(bindir)/flowd-reader
	$(INSTALL) -m 0644 flowd.8 $(mandir)/man8/flowd.8
	$(INSTALL) -m 0644 flowd.conf.5 $(mandir)/man5/flowd.conf.5
	$(INSTALL) -m 0644 flowd-reader.8 $(mandir)/man8/flowd-reader.8

